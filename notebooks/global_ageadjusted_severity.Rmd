---
title: "R Notebook"
output: html_notebook
---

---
title: "Age adjustment vignette"
author: "Shaun Truelove"
date: "5/1/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(root = here::here())
library(tidyverse)
library(covidSeverity)
#devtools::install_github("HopkinsIDD/globaltoolboxlite", force=TRUE)
library(globaltoolboxlite)
library(foreach)
library(doParallel)

```


# GLOBAL SEVERITY using WorldPop

--DOWNLOAD SHAPEFILES
Users need to download their own shapefiles for this.



### First get the list of countries included in the GADM shapefiles

```{r}
shp <- "../raw_data/gadm36_levels_shp/gadm36_2.shp"
shp_global_adm2 <- sf::read_sf(shp)
#shp_global_adm2_afg <- sf::read_sf(shp) %>% filter(!!as.name(shp_country_var)=="AFG")
shp_data <- sf::st_set_geometry(shp_global_adm2, NULL)

country_codes_gadm <- unique(shp_global_adm2$GID_0)
country_names <- unique(shp_global_adm2$NAME_0)
country_codes <- country_codes_gadm
country_codes[country_codes=="XKO"] <- "KOS"

```


### Then get the age distributions by Admin level 2

```{r}

dir.create(file.path("../raw_data", "global_severity"), recursive = TRUE, showWarnings = FALSE)

#for (c in seq_along(country_codes)){ 
for (c in 163:length(country_codes)){ 

  # Download and save all the geotifs from worldpop
  filenames <- globaltoolboxlite::download_worldpop_agetifs(country=country_codes[c], year="2020", save_dir="../raw_data/geotifs", cores=25)
  
  age_pop_data <- globaltoolboxlite::load_worldpop_age(shp=shp, 
                                    country=country_codes[c], year="2020", 
                                    save_dir="../raw_data/geotifs", 
                                    cores=25,
                                    loc_var = "NAME_2",
                                    add_pop_to_shapefile = FALSE,
                                    shp_country_var="GID_0")
  
  age_pop_data <- age_pop_data %>% dplyr::rename(adm2=NAME_2)
  age_pop_10yr <- globaltoolboxlite::convert_wp_10yr(age_pop_data)
  readr::write_csv(age_pop_10yr, file.path("../raw_data", "global_severity", paste0(country_codes[c],"_age_pop_10yr.csv")))
  readr::write_csv(age_pop_data, file.path("../raw_data", "global_severity", paste0(country_codes[c],"_age_pop_data.csv")))
  
  # delete the geotifs to save space (they are >10G per country)
  unlink(file.path("../raw_data/geotifs", country_codes[c]), recursive = TRUE)
}

```


# ---> NEED TO COME BACK TO KOSOVO (XKO vs KOS)





### Now estimate the severity parameters for all Admin 2 locations in each country

```{r}

#for (c in seq_along(country_codes)){ 
for (c in 7:length(country_codes)){ 

  
  if (country_codes[c]=="KOS" | country_codes[c]=="XKO") next
  
  age_pop_10yr <- readr::read_csv(file.path("../raw_data", "global_severity", paste0(country_codes[c],"_age_pop_10yr.csv")))
  
  # Get proportions
  age_pop_10yr <- age_pop_10yr %>% 
      dplyr::group_by(adm2) %>%
      dplyr::mutate(prop = round(pop / sum(pop),4)) %>%
      dplyr::ungroup() 
  
  # make a geoid and province info
  age_pop_10yr <- age_pop_10yr %>% 
      #dplyr::mutate(geoid = as.character(iconvadm2)), 5, "left", 0)))
      left_join(shp_data %>% 
                  dplyr::filter(GID_0==country_codes[c]) %>%
                  dplyr::select(adm0=GID_0, country=NAME_0, 
                                adm1=GID_1, adm1_name=NAME_1, 
                                geoid=GID_2, adm2=NAME_2), 
                by="adm2")
  
  # Fix 0s in proportion when 0 population in a district
  age_pop_10yr <- age_pop_10yr %>% 
    dplyr::mutate(prop = ifelse(is.nan(prop), 0, prop))
  
  # Save the updated version
  readr::write_csv(age_pop_10yr, file.path("../raw_data", "global_severity", paste0(country_codes[c],"_age_pop_10yr.csv")))
  
  # Estimate parameters
  geo_age_params <- get_ageadjustments(age_pop_10yr,
                                       cores=25,
                                       n_sims=40,
                                       n_preds=1000,
                                       age_grps=c(seq(0,80,by=10),100),
                                       googlesheet_access=FALSE,
                                       output_dir="../raw_data/global_severity",
                                       pop_name=country_codes[c])
}

```




### Plot a map of the countries, colored by severity metrics

```{r}

library(sf)
library(tidyverse)
library(viridis)

# First generate a geodata.csv like used in the CSP
geodata <- readr::read_csv("../raw_data/BGD/BGD_age_pop_10yr.csv")
geodata <- geodata %>% 
  dplyr::group_by(geoid, adm2) %>%
  dplyr::summarize(pop = round(sum(pop)),
                admin0 = "BGD") %>%
  dplyr::select(geoid, admin2=adm2, admin0, pop)
readr::write_csv(geodata, "../raw_data/BGD/geodata.csv")




map_severity <- function(severity_var = "p_death_inf", 
                         severity_var_label = "IFR",
                         geoid_params = "../raw_data/BGD/geoid-params.csv",
                         geodata = "../raw_data/BGD/geodata.csv",
                         shp = "../raw_data/BGD/bgd_admbnda_adm2_bbs_20180410/bgd_admbnda_adm2_bbs_20180410.shp",
                         shp_name_var = "ADM2_EN",
                         label_locs = NA   ){
  suppressMessages({
    geoid_params_ <- readr::read_csv(geoid_params)
    mapdat <- read_sf(shp) %>%
      dplyr::mutate(NAME = get(shp_name_var))
    geodat <- readr::read_csv(geodata)
  })

  if ("pop" %in% colnames(mapdat)){
    mapdat <- mapdat %>% dplyr::select(-pop)
  }
  if ("geoid" %in% colnames(mapdat)){
    mapdat <- mapdat %>% dplyr::rename(geoid_v0 = geoid)
  }
  
  # Combine data into shapefile
  mapdat <- mapdat %>% 
    dplyr::left_join(geodat, by=c("NAME"="admin2")) %>%
    dplyr::left_join(geoid_params_, by=c("geoid"))
  

  # Plot it
  plt <- ggplot(mapdat) +
            geom_sf(aes(fill = get(severity_var))) +
            theme_void() +
            viridis::scale_fill_viridis() +
            labs(fill=severity_var_label)
  if (!is.na(label_locs)){
    if (tolower(label_locs)=="all"){
      plt <- plt +
        geom_text(mapdat, aes(X,Y, label=NAME), size=5)
     } else if (!is.na(label_locs)){
        label_dat <-  mapdat %>% filter(NAME %in% label_locs)
        plt <- plt + geom_sf_text(data=label_dat, aes(label=NAME), size=3, hjust=0.5)
     }
  }
  
  return(plt)
}



map_severity(severity_var = "p_death_inf", 
             severity_var_label = "IFR",
             geoid_params = "../raw_data/BGD/geoid-params.csv",
             geodata = "../raw_data/BGD/geodata.csv",
             shp = "../raw_data/BGD/bgd_admbnda_adm2_bbs_20180410/bgd_admbnda_adm2_bbs_20180410.shp",
             shp_name_var = "ADM2_EN",
             label_locs = NA)

```

