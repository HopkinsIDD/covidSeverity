---
title: "Age adjustment vignette"
author: "Shaun Truelove"
date: "5/1/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(root = here::here())
library(tidyverse)
library(covidSeverity)
devtools::install_github("HopkinsIDD/globaltoolboxlite")
library(globaltoolboxlite)

```

## Load data

```{r}
# # UNHCR data [remove before pushing], add dummy dataset
# age_data <- readr::read_csv("inst/extdata/unhcr_ages.csv")
# age_matrix <- age_data[,c(4:13)]
# rownames(age_matrix) <- age_data$geoid
# #age_data_long <- convert_age_matrix_long(age_matrix)


age_data_long <- bind_rows(
  data.frame(geoid = "010101",
             age_l = c(0, 5, 12, 18, 60, 80),
             age_r = c(5, 12, 18, 60, 80, 100),
             pop = c(112200, 132000, 81000, 252600, 21600, 600), stringsAsFactors = FALSE),
  data.frame(geoid = "020101",
             age_l = c(0, 5, 12, 18, 60, 80),
             age_r = c(5, 12, 18, 60, 80, 100),
             pop = c(110000, 152000, 60000, 202600, 27600, 1200), stringsAsFactors = FALSE))


```


## Format age data

### Once age is in long format, we need to convert it to 10-year age groups:
```{r}
age_data10yr <- make_10yr_age_data(age_data_long)
age_data <- setup_age_data(age_data = age_data10yr)

```


## Run age-adjustment
Using the correctly setup data, we can run the age adjustment parameters estimation:
```{r}
geo_age_params <- get_ageadjustments(age_data10yr,
                                     cores=4,
                                     n_sims=4,
                                     n_preds=100,
                                     age_grps=c(seq(0,80,by=10),100),
                                     googlesheet_access=TRUE,
                                     output_dir="output")
```



# Age Stratification    

### Get Age Probabilities

```{r}

# Fake CSP output data
n = 100
p_hosp <- 0.05
test_data <- 
  bind_rows(
    tibble(geoid = "010101",
           date = 1:n,
            incidI = sample(10:50, n, replace = TRUE)) %>%
      mutate(incidMild = rbinom(n, incidI, .4),
          incidH = rbinom(n, incidI, p_hosp),
          incidICU = rbinom(n, incidH, .1),
          incidVent = rbinom(n, incidICU, .1),
          incidD = rbinom(n, incidVent, .5)),
    tibble(geoid = "020101",
           date = 1:n,
           incidI = sample(100:500, n, replace = TRUE)) %>%
      mutate(incidMild = rbinom(n, incidI, .4),
          incidH = rbinom(n, incidI, p_hosp),
          incidICU = rbinom(n, incidH, .1),
          incidVent = rbinom(n, incidICU, .1),
          incidD = rbinom(n, incidVent, .5))
    )


# Load age adjustment data used in the CSP model
geoid_params <- readr::read_csv(file.path("output", "geoid-params.csv"))
params_age_dist <- readRDS(file=file.path("output", "param-age-dist.rds"))

param_name <- params_age <- list()
for (i in 1:length(params_age_dist)){
  param_name[[i]] <- params_age_dist[[i]]$param_to_est
  params_age[[i]] <- params_age_dist[[i]]$pred_sum
}
param_name <- unlist(param_name)
names(params_age) <- param_name

```




### Estimate Probabilities

```{r}

# Pr(age|infection) # This one is already calculated
p_age <- age_data$age_matrix_pct
p_age_long <- age_data$age_data_long
p_age_inf <- p_age

# Check that it sums to 1
rowSums(p_age_inf)



# Multiply Pr(age|var) * Pr(age) for each geoid

# instead of inputting p_hosp to normalize to 1, we just normalize to 1

get_p_age_given_outcome <- function(p_var = "p_hosp_inf", p_age_long, params_age){
  
  p_age_ <- p_age_long %>% 
    dplyr::select(-pop) %>% 
    dplyr::rename(p_age = prop) %>%
    dplyr::left_join(params_age[[p_var]] %>% 
                      dplyr::mutate(age = colnames(p_age)) %>% 
                       dplyr::select(-age_grp), by=c("age")) %>%
    dplyr::mutate(est_mean = est_mean * p_age,
                  est_med = est_med * p_age,
                  est_ub = est_ub * p_age,
                  est_lb = est_lb * p_age) %>%
    dplyr::group_by(geoid) %>%
    # Normalizing the outputs
    dplyr::mutate(est_mean = est_mean / sum(est_mean),
                  est_med = est_med / sum(est_med),
                  est_ub = est_ub / sum(est_ub),
                  est_lb = est_lb / sum(est_lb)) %>%
      dplyr::ungroup()
  
  return(p_age_)
}


get_p_age_given_outcome(p_var = "p_hosp_inf", p_age_long, params_age)
get_p_age_given_outcome(p_var = "p_death_inf", p_age_long, params_age)


```


```{r}

# Combine the probabilities given age for each outcome and geoid

prob_data <- p_age_long %>% select(geoid, age, p_inf = prop) %>%
  dplyr::left_join(
    get_p_age_given_outcome(p_var = "p_symp_inf", p_age_long, params_age) %>% 
    dplyr::select(geoid, age, p_symp_inf=est_med)) %>%
  dplyr::left_join(
    get_p_age_given_outcome(p_var = "p_mild_inf", p_age_long, params_age) %>% 
      dplyr::select(geoid, age, p_mild_inf=est_med)) %>%
  dplyr::left_join(
    get_p_age_given_outcome(p_var = "p_hosp_inf", p_age_long, params_age) %>% 
      dplyr::select(geoid, age, p_hosp_inf=est_med)) %>%
  dplyr::left_join(
    get_p_age_given_outcome(p_var = "p_icu_inf", p_age_long, params_age) %>% 
      dplyr::select(geoid, age, p_icu_inf=est_med)) %>%
  dplyr::left_join(
    get_p_age_given_outcome(p_var = "p_vent_inf", p_age_long, params_age) %>% 
      dplyr::select(geoid, age, p_vent_inf=est_med)) %>%
  dplyr::left_join(
    get_p_age_given_outcome(p_var = "p_death_inf", p_age_long, params_age) %>% 
      dplyr::select(geoid, age, p_death_inf=est_med)) %>%
  dplyr::left_join(
    get_p_age_given_outcome(p_var = "p_icu_hosp", p_age_long, params_age) %>% 
      dplyr::select(geoid, age, p_icu_hosp=est_med)) %>%
  dplyr::left_join(
    get_p_age_given_outcome(p_var = "p_vent_icu", p_age_long, params_age) %>% 
      dplyr::select(geoid, age, p_vent_icu=est_med)) 

 
# ## icu rate amongst hospitalized
# p_icu_inf <- list(param_to_est="p_icu_inf", 
#                   pred_mtx = p_icu_hosp$pred_mtx * p_hosp_symp$pred_mtx * p_symp_inf$pred_mtx)
# p_icu_inf$pred_sum <- p_icu_inf$pred_mtx %>% pred_sum_fn(age_grps = age_grps)


# map probabilities to outputs
prob_data_ <- prob_data %>%
  dplyr::select(geoid, age,
                incidSymp = p_symp_inf,
                incidI = p_inf,
                incidMild = p_mild_inf,
                incidH = p_hosp_inf,
                incidICU = p_icu_inf,
                incidVent = p_vent_inf,
                incidD = p_death_inf)

```





### Estimate the age-stratified outcomes

```{r}

#' Title
#'
#' @param ... 
#'
#' @return
#' @export
#'
#' @examples
rmultinom_t <- function(...){
  rmultinom(...) %>% 
    t %>% 
    as_tibble
}



#' Title
#'
#' @param data 
#' @param outcome_var 
#' @param prob_data 
#'
#' @return
#' @export
#'
#' @examples
prob_fun <- function(data,
                     outcome_var = "incidH",
                     prob_data){
  
  map(data[[outcome_var]], rmultinom_t, n=1, prob = prob_data[[outcome_var]]) %>%
    dplyr::bind_rows() %>% setNames(paste0(outcome_var, "_", prob_data$age))
}



#' Title
#'
#' @param data 
#' @param outcome_var 
#' @param prob_data 
#'
#' @return
#' @export
#'
#' @examples
prob_fun_strat <- function(data,
                     outcome_var = "incidH",
                     prob_data){
  
  map(data[[outcome_var]], rmultinom_t, n=1, prob = prob_data[[outcome_var]]) %>%
    dplyr::bind_rows() %>% setNames(paste0(outcome_var, "_", prob_data$age))
  
}



```



## Put it together

```{r}



# Test it out
test_res <- age_strat_outcome(outcome_var="incidI", outcome_data=test_data, prob_data_list, add=TRUE)

# Check it
all.equal(test_res$incidI, rowSums(test_res %>% select(contains("incidI_"))))




```



### Run the estimation

```{r}

# Test it out
test_res_all <- get_age_strat_outcomes(outcomes = c("incidI","incidMild","incidH","incidICU","incidVent","incidD"),
                                  outcome_data = test_data, 
                                  prob_data = prob_data_)

# Check it
all.equal(test_res_all$incidI, rowSums(test_res_all %>% select(contains("incidI_"))))
all.equal(test_res_all$incidD, rowSums(test_res_all %>% select(contains("incidD_"))))
all.equal(test_res_all$incidH, rowSums(test_res_all %>% select(contains("incidH_"))))
## they all match


```



# Check that the branching is close
I.e., number hospitalized by age needs to map ok to number ICU by age

```{r}

# Estimate proportion of hosp who are admitted to ICU, by age

probcheck <- test_res_all %>% dplyr::select(contains("incidH_")) / test_res_all %>% dplyr::select(contains("incidI_"))
probcheck <- test_res_all %>% dplyr::select(contains("incidI_")) - test_res_all %>% dplyr::select(contains("incidH_"))

probcheck <- test_res_all %>% dplyr::select(contains("incidH_")) - test_res_all %>% dplyr::select(contains("incidICU_"))
probcheck <- test_res_all %>% dplyr::select(contains("incidICU_")) - test_res_all %>% dplyr::select(contains("incidVent_"))

test_res_all$incidVent - test_res_all$incidD
probcheck <- test_res_all %>% dplyr::select(contains("incidVent_")) - test_res_all %>% dplyr::select(contains("incidD_"))



```

It's not great. First pass will be to sample out where they dont match







```{r}



get_age_strat_outcomes <- function(outcomes=c("incidI","incidMild","incidH","incidICU","incidVent","incidD"), 
                              outcome_data, 
                              prob_data){
  
  prob_data_list <- prob_data_ %>% split(.$geoid)

  outcome_data <- test_data
  
  outcome_data <- age_strat_outcome(outcome_var="incidI", outcome_data=outcome_data, prob_data_list=prob_data_list, add=TRUE)

  outcomes <- outcomes[outcomes!="incidI"]
  for (i in seq_along(outcomes)){
    
    # Get stratified outcomes of each outcome
    outcome_data <- age_strat_outcome(outcome_var=outcomes[i], outcome_data=outcome_data, prob_data_list=prob_data_list, add=TRUE)
    
    
    
  }

  return(outcome_data)
}



```





















